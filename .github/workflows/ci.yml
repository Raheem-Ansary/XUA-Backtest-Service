name: CI

on:
  push:
  pull_request:

jobs:
  smoke:
    name: Smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]

    env:
      NEXT_PUBLIC_API_BASE_URL: http://127.0.0.1:8000
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/pyproject.toml ]; then
            python -m pip install -e backend
          elif [ -f backend/requirements.txt ]; then
            python -m pip install -r backend/requirements.txt
          else
            echo "No backend dependency file found." >&2
            exit 1
          fi
          python -m pip install uvicorn

      - name: Install backend dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "backend/pyproject.toml") {
            python -m pip install -e backend
          }
          elseif (Test-Path "backend/requirements.txt") {
            python -m pip install -r backend/requirements.txt
          }
          else {
            Write-Error "No backend dependency file found."
            exit 1
          }
          python -m pip install uvicorn

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable Yarn 1.22.22 (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate
          yarn --version

      - name: Enable Yarn 1.22.22 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate
          yarn --version

      - name: Install frontend dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        working-directory: frontend
        run: yarn install --frozen-lockfile

      - name: Install frontend dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: frontend
        run: yarn install --frozen-lockfile

      - name: Build frontend (Linux)
        if: runner.os == 'Linux'
        shell: bash
        working-directory: frontend
        run: yarn build > ../frontend-build.log 2>&1

      - name: Build frontend (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: frontend
        run: yarn build *> ../frontend-build.log

      - name: Start backend (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          python -m uvicorn backend.main:app --host 127.0.0.1 --port 8000 --log-level debug > backend.stdout.log 2> backend.stderr.log &
          echo "BACKEND_PID=$!" >> "$GITHUB_ENV"

      - name: Start backend (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $stdout = Join-Path $PWD "backend.stdout.log"
          $stderr = Join-Path $PWD "backend.stderr.log"
          $proc = Start-Process -FilePath python -ArgumentList @("-m", "uvicorn", "backend.main:app", "--host", "127.0.0.1", "--port", "8000", "--log-level", "debug") -RedirectStandardOutput $stdout -RedirectStandardError $stderr -PassThru
          "BACKEND_PID=$($proc.Id)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Health check (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          python - <<'PY'
          import json
          import sys
          import time
          import urllib.request
          import urllib.error

          url = "http://127.0.0.1:8000/health"
          last_error = None
          for attempt in range(1, 46):
              try:
                  with urllib.request.urlopen(url, timeout=2) as resp:
                      body = resp.read().decode("utf-8", "replace")
                      print(f"[health] attempt={attempt} status={resp.status} body={body}")
                      if resp.status == 200:
                          sys.exit(0)
              except Exception as exc:  # noqa: BLE001
                  last_error = exc
                  print(f"[health] attempt={attempt} error={exc}")
              time.sleep(2)

          print(f"Health check failed. last_error={last_error}", file=sys.stderr)
          sys.exit(1)
          PY

      - name: Health check (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          @'
          import sys
          import time
          import urllib.error
          import urllib.request

          url = "http://127.0.0.1:8000/health"
          last_error = None
          for attempt in range(1, 46):
              try:
                  with urllib.request.urlopen(url, timeout=2) as resp:
                      body = resp.read().decode("utf-8", "replace")
                      print(f"[health] attempt={attempt} status={resp.status} body={body}")
                      if resp.status == 200:
                          raise SystemExit(0)
              except Exception as exc:
                  last_error = exc
                  print(f"[health] attempt={attempt} error={exc}")
              time.sleep(2)

          print(f"Health check failed. last_error={last_error}", file=sys.stderr)
          raise SystemExit(1)
          '@ | Set-Content -Path healthcheck.py -Encoding utf8
          python healthcheck.py

      - name: Print logs on failure (Linux)
        if: failure() && runner.os == 'Linux'
        shell: bash
        run: |
          echo "===== backend stdout ====="
          [ -f backend.stdout.log ] && cat backend.stdout.log || echo "missing backend.stdout.log"
          echo "===== backend stderr ====="
          [ -f backend.stderr.log ] && cat backend.stderr.log || echo "missing backend.stderr.log"
          echo "===== frontend build log ====="
          [ -f frontend-build.log ] && cat frontend-build.log || echo "missing frontend-build.log"

      - name: Print logs on failure (Windows)
        if: failure() && runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "===== backend stdout ====="
          if (Test-Path "backend.stdout.log") { Get-Content "backend.stdout.log" } else { Write-Host "missing backend.stdout.log" }
          Write-Host "===== backend stderr ====="
          if (Test-Path "backend.stderr.log") { Get-Content "backend.stderr.log" } else { Write-Host "missing backend.stderr.log" }
          Write-Host "===== frontend build log ====="
          if (Test-Path "frontend-build.log") { Get-Content "frontend-build.log" } else { Write-Host "missing frontend-build.log" }

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.os }}
          if-no-files-found: warn
          path: |
            backend.stdout.log
            backend.stderr.log
            frontend-build.log

      - name: Stop backend (Linux)
        if: always() && runner.os == 'Linux'
        shell: bash
        run: |
          if [ -n "${BACKEND_PID:-}" ]; then
            kill "$BACKEND_PID" || true
          fi

      - name: Stop backend (Windows)
        if: always() && runner.os == 'Windows'
        shell: pwsh
        run: |
          if ($env:BACKEND_PID) {
            Stop-Process -Id ([int]$env:BACKEND_PID) -Force -ErrorAction SilentlyContinue
          }
