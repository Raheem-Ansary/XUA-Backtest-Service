name: CI

on:
  push:
  pull_request:

jobs:
  build-test:
    name: CI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]

    env:
      NEXT_PUBLIC_API_BASE_URL: http://127.0.0.1:8000
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/pyproject.toml

      - name: Detect backend dependency manager
        id: backend-deps
        shell: pwsh
        run: |
          if (Test-Path "backend/pyproject.toml") {
            "manager=pyproject" >> $env:GITHUB_OUTPUT
            Write-Host "[backend] dependency source: pyproject.toml"
          }
          elseif (Test-Path "backend/requirements.txt") {
            "manager=requirements" >> $env:GITHUB_OUTPUT
            Write-Host "[backend] dependency source: requirements.txt"
          }
          else {
            Write-Error "No backend dependency file found. Expected backend/pyproject.toml or backend/requirements.txt"
            exit 1
          }

      - name: Install backend dependencies (pyproject)
        if: steps.backend-deps.outputs.manager == 'pyproject'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          Push-Location backend
          python -m pip install -e .
          Pop-Location
          python -m pip install pytest uvicorn

      - name: Install backend dependencies (requirements)
        if: steps.backend-deps.outputs.manager == 'requirements'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r backend/requirements.txt
          python -m pip install pytest uvicorn

      - name: Backend smoke diagnostics
        shell: pwsh
        run: |
          Write-Host "[diag] Python executable:"; python -c "import sys; print(sys.executable)"
          Write-Host "[diag] Python version:"; python --version
          Write-Host "[diag] sys.path:"; python -c "import sys, pprint; pprint.pprint(sys.path)"
          Write-Host "[diag] backend files:"; Get-ChildItem -Path backend -Recurse -Depth 4 | Select-Object FullName

      - name: Detect backend ASGI module path
        id: backend-module
        shell: pwsh
        run: |
          function HasFastApiApp($path) {
            if (-not (Test-Path $path)) { return $false }
            $content = Get-Content $path -Raw
            return ($content -match "app\s*=\s*FastAPI\s*\(")
          }

          $module = $null

          if (HasFastApiApp "backend/main.py") {
            $module = "main:app"
          }
          elseif (HasFastApiApp "backend/app/main.py") {
            $module = "app.main:app"
          }
          elseif (HasFastApiApp "backend/src/app/main.py") {
            $module = "src.app.main:app"
          }
          else {
            Write-Host "[diag] No standard ASGI path matched. Searching backend for FastAPI candidates..."
            $candidates = Get-ChildItem backend -Recurse -Filter *.py |
              Where-Object {
                $raw = Get-Content $_.FullName -Raw
                ($raw -match "FastAPI\s*\(") -and ($raw -match "app\s*=")
              }

            if ($candidates) {
              Write-Host "[diag] Candidate FastAPI files:"
              foreach ($c in $candidates) {
                Write-Host " - $($c.FullName)"
              }
            }
            else {
              Write-Host "[diag] No FastAPI candidates found under backend/."
            }

            if (Test-Path "backend/main.py") {
              $module = "main:app"
              Write-Host "[diag] Falling back to main:app"
            }
            elseif (Test-Path "backend/app/main.py") {
              $module = "app.main:app"
              Write-Host "[diag] Falling back to app.main:app"
            }
            elseif (Test-Path "backend/src/app/main.py") {
              $module = "src.app.main:app"
              Write-Host "[diag] Falling back to src.app.main:app"
            }
            else {
              Write-Error "Unable to determine ASGI module path for backend."
              exit 1
            }
          }

          "module=$module" >> $env:GITHUB_OUTPUT
          Write-Host "[backend] ASGI module selected: $module"

      - name: Verify health endpoint exists
        shell: pwsh
        run: |
          $healthFound = $false
          $files = Get-ChildItem backend -Recurse -Filter *.py
          foreach ($f in $files) {
            $raw = Get-Content $f.FullName -Raw
            if ($raw -match "@app\.get\(\s*['\"]\/health['\"]") {
              $healthFound = $true
              Write-Host "[backend] Found /health in $($f.FullName)"
              break
            }
          }

          if (-not $healthFound) {
            Write-Error "No /health endpoint found. Add @app.get('/health') returning status 200 JSON."
            exit 1
          }

      - name: Run backend tests if present
        shell: pwsh
        run: |
          if (Test-Path "backend/tests") {
            Write-Host "[backend] Running pytest..."
            python -m pytest -q backend/tests
          }
          else {
            Write-Host "[backend] No backend/tests found; proceeding with integration health check."
          }

      - name: Detect frontend package manager
        id: frontend-pm
        shell: pwsh
        run: |
          if (Test-Path "frontend/pnpm-lock.yaml") {
            "pm=pnpm" >> $env:GITHUB_OUTPUT
            "lockfile=frontend/pnpm-lock.yaml" >> $env:GITHUB_OUTPUT
            Write-Host "[frontend] package manager: pnpm"
          }
          elseif (Test-Path "frontend/yarn.lock") {
            "pm=yarn" >> $env:GITHUB_OUTPUT
            "lockfile=frontend/yarn.lock" >> $env:GITHUB_OUTPUT
            Write-Host "[frontend] package manager: yarn"
          }
          elseif (Test-Path "frontend/package-lock.json") {
            "pm=npm" >> $env:GITHUB_OUTPUT
            "lockfile=frontend/package-lock.json" >> $env:GITHUB_OUTPUT
            Write-Host "[frontend] package manager: npm"
          }
          else {
            Write-Error "No frontend lockfile found. Expected pnpm-lock.yaml, yarn.lock, or package-lock.json"
            exit 1
          }

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: ${{ steps.frontend-pm.outputs.pm }}
          cache-dependency-path: ${{ steps.frontend-pm.outputs.lockfile }}

      - name: Setup pnpm
        if: steps.frontend-pm.outputs.pm == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install frontend dependencies
        shell: pwsh
        working-directory: frontend
        run: |
          if ("${{ steps.frontend-pm.outputs.pm }}" -eq "pnpm") {
            pnpm install --frozen-lockfile
          }
          elseif ("${{ steps.frontend-pm.outputs.pm }}" -eq "yarn") {
            yarn install --frozen-lockfile
          }
          else {
            npm ci
          }

      - name: Run frontend lint (if available)
        shell: pwsh
        working-directory: frontend
        run: |
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          $hasLint = $null -ne $pkg.scripts -and $null -ne $pkg.scripts.lint

          if ($hasLint) {
            Write-Host "[frontend] Running lint..."
            if ("${{ steps.frontend-pm.outputs.pm }}" -eq "pnpm") {
              pnpm run lint
            }
            elseif ("${{ steps.frontend-pm.outputs.pm }}" -eq "yarn") {
              yarn lint
            }
            else {
              npm run lint
            }
          }
          else {
            Write-Host "[frontend] No lint script found. Skipping lint."
          }

      - name: Build frontend
        shell: pwsh
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE_URL: http://127.0.0.1:8000
        run: |
          Write-Host "[frontend] Building with NEXT_PUBLIC_API_BASE_URL=$env:NEXT_PUBLIC_API_BASE_URL"
          if ("${{ steps.frontend-pm.outputs.pm }}" -eq "pnpm") {
            pnpm run build
          }
          elseif ("${{ steps.frontend-pm.outputs.pm }}" -eq "yarn") {
            yarn build
          }
          else {
            npm run build
          }

      - name: Start backend server (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $module = "${{ steps.backend-module.outputs.module }}"
          $backendDir = (Resolve-Path "backend").Path
          $logFile = Join-Path $backendDir "backend.log"

          if (Test-Path $logFile) { Remove-Item $logFile -Force }

          Write-Host "[backend] Starting uvicorn in: $backendDir"
          Write-Host "[backend] Module: $module"
          Write-Host "[backend] Log: $logFile"

          "BACKEND_LOG=$logFile" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          $proc = Start-Process -FilePath "python" `
            -ArgumentList @("-m","uvicorn",$module,"--host","127.0.0.1","--port","8000") `
            -WorkingDirectory $backendDir `
            -PassThru `
            -RedirectStandardOutput $logFile `
            -RedirectStandardError $logFile
          "BACKEND_PID=$($proc.Id)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          Write-Host "[backend] PID: $($proc.Id)"
          Write-Host "[diag] netstat snapshot after spawn:"
          netstat -ano | Select-String ":8000" | ForEach-Object { $_.ToString() }

      - name: Start backend server (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          module="${{ steps.backend-module.outputs.module }}"
          log="$PWD/backend/backend.log"
          rm -f "$log"
          (
            cd backend
            python -m uvicorn "$module" --host 127.0.0.1 --port 8000 > "$log" 2>&1
          ) &
          echo "BACKEND_PID=$!" >> "$GITHUB_ENV"
          echo "BACKEND_LOG=$log" >> "$GITHUB_ENV"
          echo "[backend] PID: $!"
          echo "[diag] netstat snapshot after spawn:"
          netstat -anp 2>/dev/null | grep 8000 || true

      - name: Health check (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          function Resolve-BackendLogPath {
            $candidates = @()
            if ($env:BACKEND_LOG) { $candidates += $env:BACKEND_LOG }
            $candidates += @("backend\\backend.log","backend.log")
            return ($candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1)
          }

          $url = "http://127.0.0.1:8000/health"
          $ok = $false
          for ($i = 1; $i -le 30; $i++) {
            Write-Host "[Attempt $i/30] GET $url"
            try {
              $resp = Invoke-WebRequest -Uri $url -Method Get -UseBasicParsing -TimeoutSec 3
              Write-Host "[health] HTTP $($resp.StatusCode)"
              if ($resp.StatusCode -eq 200) {
                Write-Host "[health] body: $($resp.Content)"
                $ok = $true
                break
              }
            }
            catch {
              Write-Host "[health] failed: $($_.Exception.Message)"
            }
            Start-Sleep -Seconds 2
          }

          if (-not $ok) {
            Write-Error "Health check failed on Windows: $url"
            Write-Host "===== backend.log (tail 300) ====="
            $logPath = Resolve-BackendLogPath
            if ($logPath) { Get-Content $logPath -Tail 300 } else { Write-Host "No backend log found." }
            Write-Host "===== netstat :8000 ====="
            netstat -ano | Select-String ":8000" | ForEach-Object { $_.ToString() }
            Write-Host "===== Python sys.path ====="
            python -c "import sys, pprint; pprint.pprint(sys.path)"
            Write-Host "===== backend tree (depth 4) ====="
            Get-ChildItem -Path backend -Recurse -Depth 4 | Select-Object FullName
            exit 1
          }

      - name: Health check (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          url="http://127.0.0.1:8000/health"
          ok=0
          for i in $(seq 1 30); do
            echo "[Attempt $i/30] GET $url"
            code=$(curl -s -o /tmp/health.json -w "%{http_code}" "$url" || true)
            echo "[health] HTTP $code"
            if [ "$code" = "200" ]; then
              echo "[health] body:"; cat /tmp/health.json || true
              ok=1
              break
            fi
            sleep 2
          done

          if [ "$ok" -ne 1 ]; then
            echo "Health check failed on Linux: $url" >&2
            echo "===== backend.log (tail 300) ====="
            if [ -f "$BACKEND_LOG" ]; then tail -n 300 "$BACKEND_LOG"; else echo "Missing log file: $BACKEND_LOG"; fi
            echo "===== netstat :8000 ====="
            netstat -anp 2>/dev/null | grep 8000 || true
            echo "===== Python sys.path ====="
            python -c "import sys, pprint; pprint.pprint(sys.path)"
            echo "===== backend tree (depth 4) ====="
            find backend -maxdepth 4 -print
            exit 1
          fi

      - name: Print backend log (Windows)
        if: always() && runner.os == 'Windows'
        shell: pwsh
        run: |
          $candidates = @()
          if ($env:BACKEND_LOG) { $candidates += $env:BACKEND_LOG }
          $candidates += @("backend\\backend.log","backend.log")
          $logPath = $candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1

          Write-Host "===== backend.log (full) ====="
          if ($logPath) { Get-Content $logPath -Raw | Write-Host } else { Write-Host "No backend log found." }

      - name: Print backend log on failure (Linux)
        if: failure() && runner.os == 'Linux'
        shell: bash
        run: |
          echo "===== backend.log (full) ====="
          if [ -f "$BACKEND_LOG" ]; then cat "$BACKEND_LOG"; else echo "No backend log file found."; fi

      - name: Stop backend server (Windows)
        if: always() && runner.os == 'Windows'
        shell: pwsh
        run: |
          if ($env:BACKEND_PID) {
            Write-Host "Stopping backend PID $env:BACKEND_PID"
            Stop-Process -Id $env:BACKEND_PID -Force -ErrorAction SilentlyContinue
          }

      - name: Stop backend server (Linux)
        if: always() && runner.os == 'Linux'
        shell: bash
        run: |
          if [ -n "${BACKEND_PID:-}" ]; then
            echo "Stopping backend PID $BACKEND_PID"
            kill "$BACKEND_PID" || true
          fi
