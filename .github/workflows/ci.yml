name: CI

on:
  push:
  pull_request:

jobs:
  build-test:
    name: CI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]

    env:
      NEXT_PUBLIC_API_BASE_URL: http://127.0.0.1:8000
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/pyproject.toml

      - name: Detect backend dependency manager
        id: backend-deps
        shell: pwsh
        run: |
          if (Test-Path "backend/pyproject.toml") {
            "manager=pyproject" >> $env:GITHUB_OUTPUT
            Write-Host "[backend] dependency source: pyproject.toml"
          }
          elseif (Test-Path "backend/requirements.txt") {
            "manager=requirements" >> $env:GITHUB_OUTPUT
            Write-Host "[backend] dependency source: requirements.txt"
          }
          else {
            Write-Error "No backend dependency file found. Expected backend/pyproject.toml or backend/requirements.txt"
            exit 1
          }

      - name: Install backend dependencies (pyproject)
        if: steps.backend-deps.outputs.manager == 'pyproject'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          Push-Location backend
          python -m pip install -e .
          Pop-Location
          python -m pip install pytest uvicorn

      - name: Install backend dependencies (requirements)
        if: steps.backend-deps.outputs.manager == 'requirements'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r backend/requirements.txt
          python -m pip install pytest uvicorn

      - name: Backend smoke diagnostics
        shell: pwsh
        run: |
          Write-Host "[diag] Python executable:"; python -c "import sys; print(sys.executable)"
          Write-Host "[diag] Python version:"; python --version
          Write-Host "[diag] sys.path:"; python -c "import sys, pprint; pprint.pprint(sys.path)"
          Write-Host "[diag] backend files:"; Get-ChildItem -Path backend -Recurse -Depth 4 | Select-Object FullName

      - name: Detect backend ASGI module path (Windows CMD)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          @echo off
          set MODULE=
          if exist backend\main.py (
            set MODULE=main:app
          ) else if exist backend\app\main.py (
            set MODULE=app.main:app
          ) else if exist backend\src\app\main.py (
            set MODULE=src.app.main:app
          ) else (
            echo [backend] Could not detect ASGI module path.
            dir backend /s /b
            exit /b 1
          )
          echo [backend] ASGI module selected: %MODULE%
          echo BACKEND_MODULE=%MODULE%>>"%GITHUB_ENV%"

      - name: Detect backend ASGI module path (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          module=""
          if [ -f backend/main.py ]; then
            module="main:app"
          elif [ -f backend/app/main.py ]; then
            module="app.main:app"
          elif [ -f backend/src/app/main.py ]; then
            module="src.app.main:app"
          else
            echo "[backend] Could not detect ASGI module path." >&2
            find backend -maxdepth 5 -type f -name "*.py" -print
            exit 1
          fi
          echo "[backend] ASGI module selected: $module"
          echo "BACKEND_MODULE=$module" >> "$GITHUB_ENV"

      - name: Run backend tests if present
        shell: pwsh
        run: |
          if (Test-Path "backend/tests") {
            Write-Host "[backend] Running pytest..."
            python -m pytest -q backend/tests
          }
          else {
            Write-Host "[backend] No backend/tests found; proceeding with integration health check."
          }

      - name: Detect frontend package manager
        id: frontend-pm
        shell: pwsh
        run: |
          if (Test-Path "frontend/pnpm-lock.yaml") {
            "pm=pnpm" >> $env:GITHUB_OUTPUT
            "lockfile=frontend/pnpm-lock.yaml" >> $env:GITHUB_OUTPUT
            Write-Host "[frontend] package manager: pnpm"
          }
          elseif (Test-Path "frontend/yarn.lock") {
            "pm=yarn" >> $env:GITHUB_OUTPUT
            "lockfile=frontend/yarn.lock" >> $env:GITHUB_OUTPUT
            Write-Host "[frontend] package manager: yarn"
          }
          elseif (Test-Path "frontend/package-lock.json") {
            "pm=npm" >> $env:GITHUB_OUTPUT
            "lockfile=frontend/package-lock.json" >> $env:GITHUB_OUTPUT
            Write-Host "[frontend] package manager: npm"
          }
          else {
            Write-Error "No frontend lockfile found. Expected pnpm-lock.yaml, yarn.lock, or package-lock.json"
            exit 1
          }

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: ${{ steps.frontend-pm.outputs.pm }}
          cache-dependency-path: ${{ steps.frontend-pm.outputs.lockfile }}

      - name: Setup pnpm
        if: steps.frontend-pm.outputs.pm == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install frontend dependencies
        shell: pwsh
        working-directory: frontend
        run: |
          if ("${{ steps.frontend-pm.outputs.pm }}" -eq "pnpm") {
            pnpm install --frozen-lockfile
          }
          elseif ("${{ steps.frontend-pm.outputs.pm }}" -eq "yarn") {
            yarn install --frozen-lockfile
          }
          else {
            npm ci
          }

      - name: Run frontend lint (if available)
        shell: pwsh
        working-directory: frontend
        run: |
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          $hasLint = $null -ne $pkg.scripts -and $null -ne $pkg.scripts.lint

          if ($hasLint) {
            Write-Host "[frontend] Running lint..."
            if ("${{ steps.frontend-pm.outputs.pm }}" -eq "pnpm") {
              pnpm run lint
            }
            elseif ("${{ steps.frontend-pm.outputs.pm }}" -eq "yarn") {
              yarn lint
            }
            else {
              npm run lint
            }
          }
          else {
            Write-Host "[frontend] No lint script found. Skipping lint."
          }

      - name: Build frontend
        shell: pwsh
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE_URL: http://127.0.0.1:8000
        run: |
          Write-Host "[frontend] Building with NEXT_PUBLIC_API_BASE_URL=$env:NEXT_PUBLIC_API_BASE_URL"
          if ("${{ steps.frontend-pm.outputs.pm }}" -eq "pnpm") {
            pnpm run build
          }
          elseif ("${{ steps.frontend-pm.outputs.pm }}" -eq "yarn") {
            yarn build
          }
          else {
            npm run build
          }

      - name: Start backend server (Windows CMD)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          @echo off
          if "%BACKEND_MODULE%"=="" (
            echo [backend] BACKEND_MODULE is empty
            exit /b 1
          )

          pushd backend
          if exist backend.log del /f /q backend.log

          echo BACKEND_LOG=%CD%\backend.log>>"%GITHUB_ENV%"
          echo [backend] Starting uvicorn module=%BACKEND_MODULE% in %CD%
          start "" /b python -m uvicorn %BACKEND_MODULE% --host 127.0.0.1 --port 8000 > backend.log 2>&1

          timeout /t 2 /nobreak >NUL
          echo ===== netstat :8000 after start =====
          netstat -ano | findstr :8000
          popd

      - name: Start backend server (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          module="${BACKEND_MODULE}"
          log="$PWD/backend/backend.log"
          rm -f "$log"
          (
            cd backend
            python -m uvicorn "$module" --host 127.0.0.1 --port 8000 > backend.log 2>&1
          ) &
          echo "BACKEND_PID=$!" >> "$GITHUB_ENV"
          echo "BACKEND_LOG=$log" >> "$GITHUB_ENV"
          echo "[backend] PID: $!"
          echo "[diag] netstat snapshot after spawn:"
          netstat -anp 2>/dev/null | grep 8000 || true

      - name: Health check (Windows CMD)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          @echo off
          setlocal EnableDelayedExpansion
          set OK=0

          for /l %%i in (1,1,30) do (
            set CODE=
            echo [Attempt %%i/30] Checking http://127.0.0.1:8000/health
            for /f %%s in ('curl -s -o NUL -w "%%{http_code}" http://127.0.0.1:8000/health') do set CODE=%%s
            if "!CODE!"=="200" (
              echo [health] HTTP 200
              set OK=1
              goto :done
            )
            timeout /t 2 /nobreak >NUL
          )

          :done
          if "!OK!"=="0" (
            echo Backend health check failed.
            echo ===== netstat :8000 =====
            netstat -ano | findstr :8000
            echo ===== backend log =====
            if exist backend\backend.log (
              type backend\backend.log
            ) else if exist backend.log (
              type backend.log
            ) else (
              echo No backend log found.
            )
            exit /b 1
          )

      - name: Health check (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          url="http://127.0.0.1:8000/health"
          ok=0
          for i in $(seq 1 30); do
            echo "[Attempt $i/30] GET $url"
            code=$(curl -s -o /tmp/health.json -w "%{http_code}" "$url" || true)
            echo "[health] HTTP $code"
            if [ "$code" = "200" ]; then
              echo "[health] body:"; cat /tmp/health.json || true
              ok=1
              break
            fi
            sleep 2
          done

          if [ "$ok" -ne 1 ]; then
            echo "Health check failed on Linux: $url" >&2
            echo "===== backend.log ====="
            if [ -f "backend/backend.log" ]; then cat "backend/backend.log"; else echo "No backend log file found."; fi
            echo "===== netstat :8000 ====="
            netstat -anp 2>/dev/null | grep 8000 || true
            exit 1
          fi

      - name: Print backend log (Windows CMD)
        if: always() && runner.os == 'Windows'
        shell: cmd
        run: |
          @echo off
          echo ===== backend log (always) =====
          if exist backend\backend.log (
            type backend\backend.log
          ) else if exist backend.log (
            type backend.log
          ) else (
            echo No backend log found.
          )

      - name: Print backend log (Linux)
        if: always() && runner.os == 'Linux'
        shell: bash
        run: |
          echo "===== backend log (always) ====="
          if [ -f "backend/backend.log" ]; then
            cat "backend/backend.log"
          else
            echo "No backend log file found."
          fi

      - name: Stop backend server (Linux)
        if: always() && runner.os == 'Linux'
        shell: bash
        run: |
          if [ -n "${BACKEND_PID:-}" ]; then
            echo "Stopping backend PID $BACKEND_PID"
            kill "$BACKEND_PID" || true
          fi
